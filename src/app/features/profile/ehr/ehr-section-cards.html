<ng-container *ngIf="selectedTab === 'ehr'">

        <!-- Doctor Visits Card (Updated UI) -->
        <div class="ehr-section-card doctor-visits">
          <div class="doctor-visits-header">
            <div class="card-title">
              <ion-icon name="snow-outline" color="primary"></ion-icon>
              <h3>Doctor Visits</h3>
            </div>
            <ion-button size="small" fill="clear" class="doctor-visits-add-btn" (click)="openAddDoctorVisitModal()">
              <span class="plus-icon">+</span>
              <span>Add Visit</span>
            </ion-button>
          </div>
          <div>
            <div *ngFor="let visit of doctorVisits" class="doctor-visit-card" (click)="openVisitDetailsHandler(visit)">
              <div class="doctor-visit-row">
                <div class="doctor-visit-info">
                  <div class="doctor-visit-name">{{ visit.doctorName }}</div>
                  <div class="doctor-visit-date">{{ visit.visitDate | date:'MMM d, y' }}</div>
                </div>
                <span class="doctor-visit-type">{{ visit.visitType }}</span>
                  <ion-button 
                    fill="clear" 
                    size="small" 
                    class="menu-toggle-btn"
                    (click)="presentVisitActionsPopoverHandler($event, visit); $event.stopPropagation()"
                    #visitPopoverTrigger>
                    <ion-icon name="ellipsis-vertical-outline" style="color: #3a6eea; font-size: 18px; cursor: pointer;"></ion-icon>
                  </ion-button>
                  <ion-popover
                    [isOpen]="visitActionsPopover === visit"
                    [event]="visitActionsEvent"
                    (ionPopoverDidDismiss)="visitActionsPopover = null; visitActionsEvent = null">
                    <ng-template>
                      <ion-list>
                        <ion-item button (click)="editDoctorVisitHandler(visit); visitActionsPopover = null">
                          <ion-icon name="create-outline" slot="start" style="color: #3a6eea;"></ion-icon>
                          Edit Doctor Visit
                        </ion-item>
                        <ion-item button (click)="deleteDoctorVisitHandler(visit); visitActionsPopover = null">
                          <ion-icon name="trash-outline" slot="start" style="color: #ea3a3a;"></ion-icon>
                          <span style="color: #ea3a3a;">Delete Doctor Visit</span>
                        </ion-item>
                      </ion-list>
                    </ng-template>
                  </ion-popover>
              </div>
            </div>
            <div *ngIf="doctorVisits.length === 0" class="no-data">
              <p>No doctor visits recorded yet</p>
            </div>
          </div>
        </div>

         <!-- Medical History Card -->
        <div class="ehr-section-card">
          <div class="card-header">
            <div class="card-title">
              <ion-icon name="document-text-outline" color="secondary"></ion-icon>
              <h3>Medical History</h3>
            </div>
            <ion-button size="small" fill="clear" (click)="openAddMedicalHistoryModal()">
              <ion-icon name="add-outline" slot="start"></ion-icon>
              Add Condition
            </ion-button>
          </div>

          <div class="card-content">
            <!-- Loading state -->
            <div *ngIf="isLoadingMedicalHistory" class="loading-state">
              <ion-skeleton-text animated style="width: 100%; height: 60px; margin-bottom: 10px;"></ion-skeleton-text>
              <ion-skeleton-text animated style="width: 80%; height: 40px; margin-bottom: 10px;"></ion-skeleton-text>
              <ion-skeleton-text animated style="width: 60%; height: 30px;"></ion-skeleton-text>
            </div>
            
            <!-- Data loaded state -->
            <div *ngIf="!isLoadingMedicalHistory && medicalHistory.length > 0">
              <div *ngFor="let history of (isMedicalHistoryExpanded ? medicalHistory : (medicalHistory | slice:0:3))" 
                   class="history-summary-card">
                <div class="history-summary-header">
                  <div class="history-summary-info">
                    <h4 class="history-condition">{{ history.condition }}</h4>
                    <p class="history-date">Diagnosed: {{ history.diagnosisDate | date:'MMM d, y' }}</p>
                  </div>
                  <div class="history-header-actions">
                    <ion-chip class="history-status-chip" size="small">
                      {{ history.status }}
                    </ion-chip>
                    <ion-button fill="clear" size="small" class="menu-toggle-btn history-menu-btn" (click)="presentHistoryActionsPopoverHandler($event, history); $event.stopPropagation()" #popoverTrigger>
                      <ion-icon name="ellipsis-vertical-outline" class="history-menu-icon"></ion-icon>
                    </ion-button>
                  </div>
                </div>
                <p class="history-notes" *ngIf="history.notes">{{ history.notes | slice:0:100 }}{{ history.notes.length > 100 ? '...' : '' }}</p>
                <div class="history-click-hint">
                  <ion-icon name="eye-outline" class="history-eye-icon"></ion-icon>
                  <a class="history-details-link" (click)="openMedicalHistoryDetailsHandler(history)">Click to view full details</a>
                </div>
              </div>
              
              <div *ngIf="medicalHistory.length > 3" class="view-all-link">
                <ion-button fill="clear" size="small" (click)="expandMedicalHistoryHandler()">
                  {{ isMedicalHistoryExpanded ? 'Show less' : 'View all ' + medicalHistory.length + ' conditions' }}
                  <ion-icon [name]="isMedicalHistoryExpanded ? 'chevron-up-outline' : 'chevron-down-outline'" slot="end"></ion-icon>
                </ion-button>
              </div>
            </div>

            <!-- No data state -->
            <div *ngIf="!isLoadingMedicalHistory && medicalHistory.length === 0" class="empty-state">
              <ion-icon name="document-text-outline" class="empty-icon"></ion-icon>
              <p class="empty-title">No medical history recorded</p>
              <p class="empty-subtitle">Document your medical conditions and diagnoses</p>
              <ion-button fill="outline" size="small" (click)="openAddMedicalHistoryModal()">
                <ion-icon name="add-outline" slot="start"></ion-icon>
                Add Condition
              </ion-button>
            </div>
          </div>
        </div>

        <!-- EHR Access Management Card -->
        <div class="ehr-section-card">
          <div class="card-header">
            <div class="card-title">
              <ion-icon name="people-outline" color="tertiary"></ion-icon>
              <h3>Provider Access</h3>
            </div>
          </div>

          <div class="card-content">
            <p class="access-description">Send access requests to verified healthcare providers for coordinated care.</p>
            
            <div class="add-provider-section">
              <ion-item lines="none" class="provider-input">
                <ion-label position="stacked">Provider Email</ion-label>
                <ion-input 
                  [(ngModel)]="newProviderEmail" 
                  placeholder="doctor@example.com"
                  type="email">
                </ion-input>
              </ion-item>
              
              <ion-item lines="none" class="provider-input">
                <ion-label position="stacked">Provider Name</ion-label>
                <ion-input 
                  [(ngModel)]="newProviderName" 
                  placeholder="Dr. Sarah Johnson">
                </ion-input>
              </ion-item>
              
              <ion-item lines="none" class="provider-input">
                <ion-label position="stacked">Provider Role</ion-label>
                <ion-select [(ngModel)]="newProviderRole" interface="popover">
                  <ion-select-option value="doctor">Doctor</ion-select-option>
                  <ion-select-option value="nurse">Nurse</ion-select-option>
                </ion-select>
              </ion-item>
              
              <!-- Optional Fields -->
              <ion-item lines="none" class="provider-input">
                <ion-label position="stacked">License Number <span class="optional-label">(Optional)</span></ion-label>
                <ion-input 
                  [(ngModel)]="newProviderLicense" 
                  placeholder="e.g., MD12345">
                </ion-input>
              </ion-item>
              
              <ion-item lines="none" class="provider-input">
                <ion-label position="stacked">Specialty <span class="optional-label">(Optional)</span></ion-label>
                <ion-input 
                  [(ngModel)]="newProviderSpecialty" 
                  placeholder="e.g., Cardiology, Family Medicine">
                </ion-input>
              </ion-item>
              
              <ion-item lines="none" class="provider-input">
                <ion-label position="stacked">Hospital/Clinic <span class="optional-label">(Optional)</span></ion-label>
                <ion-input 
                  [(ngModel)]="newProviderHospital" 
                  placeholder="e.g., City General Hospital">
                </ion-input>
              </ion-item>
              
              <ion-button class="provider-access-btn" (click)="sendAccessRequestHandler()" [disabled]="!newProviderEmail || !newProviderName">
                <ion-icon name="paper-plane-outline" slot="start"></ion-icon>
                Send Access Request
              </ion-button>
              
              <p class="help-text">
                <ion-icon name="information-circle-outline"></ion-icon>
                The provider must be registered in the system and will need to accept your request.
              </p>
            </div>

            <div class="current-access" *ngIf="ehrAccessList.length > 0">
              <h4>Current Provider Access</h4>
              <div class="access-list">
                <div *ngFor="let provider of ehrAccessList" class="access-item">
                  <div class="provider-info">
                    <ion-icon name="person-outline"></ion-icon>
                    <span>{{ provider }}</span>
                  </div>
                  <ion-button 
                    fill="clear" 
                    color="danger" 
                    size="small"
                    (click)="revokeEHRAccessHandler(provider)">
                    <ion-icon name="trash-outline"></ion-icon>
                  </ion-button>
                </div>
              </div>
            </div>

            <div *ngIf="ehrAccessList.length === 0" class="no-access">
              <p class="empty-subtitle">No providers have access to your EHR</p>
            </div>
          </div>
        </div>

      </ng-container>
