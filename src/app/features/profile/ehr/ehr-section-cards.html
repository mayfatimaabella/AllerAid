<ng-container *ngIf="selectedTab === 'ehr'">

        <!-- Doctor Visits Card (Updated UI) -->
        <div class="ehr-section-card doctor-visits">
          <div class="doctor-visits-header">
            <div class="card-title">
              <ion-icon name="snow-outline" color="primary"></ion-icon>
              <h3>Doctor Visits</h3>
            </div>
            <ion-button size="small" fill="clear" class="doctor-visits-add-btn" (click)="openAddDoctorVisitModal()">
              <span class="plus-icon">+</span>
              <span>Add Visit</span>
            </ion-button>
          </div>
          <div>
            <div *ngFor="let visit of doctorVisits" class="doctor-visit-card" (click)="openVisitDetailsHandler(visit)">
              <div class="doctor-visit-row">
                <div class="doctor-visit-info">
                  <div class="doctor-visit-name">{{ visit.doctorName }}</div>
                  <div class="doctor-visit-date">{{ visit.visitDate | date:'MMM d, y' }}</div>
                </div>
                <span class="doctor-visit-type">{{ visit.visitType }}</span>
                  <ion-button 
                    fill="clear" 
                    size="small" 
                    class="menu-toggle-btn"
                    (click)="presentVisitActionsPopoverHandler($event, visit); $event.stopPropagation()"
                    #visitPopoverTrigger>
                    <ion-icon name="ellipsis-vertical-outline" style="color: #3a6eea; font-size: 18px; cursor: pointer;"></ion-icon>
                  </ion-button>
                  <ion-popover
                    [isOpen]="visitActionsPopover === visit"
                    [event]="visitActionsEvent"
                    (ionPopoverDidDismiss)="visitActionsPopover = null; visitActionsEvent = null">
                    <ng-template>
                      <ion-list>
                        <ion-item button (click)="editDoctorVisitHandler(visit); visitActionsPopover = null">
                          <ion-icon name="create-outline" slot="start" style="color: #3a6eea;"></ion-icon>
                          Edit Doctor Visit
                        </ion-item>
                        <ion-item button (click)="deleteDoctorVisitHandler(visit); visitActionsPopover = null">
                          <ion-icon name="trash-outline" slot="start" style="color: #ea3a3a;"></ion-icon>
                          <span style="color: #ea3a3a;">Delete Doctor Visit</span>
                        </ion-item>
                      </ion-list>
                    </ng-template>
                  </ion-popover>
              </div>
            </div>
            <div *ngIf="doctorVisits.length === 0" class="no-data">
              <p>No doctor visits recorded yet</p>
            </div>
          </div>
        </div>

         <!-- Medical History Card -->
        <div class="ehr-section-card">
          <div class="card-header">
            <div class="card-title">
              <ion-icon name="document-text-outline" color="secondary"></ion-icon>
              <h3>Medical History</h3>
            </div>
            <ion-button size="small" fill="clear" (click)="openAddMedicalHistoryModal()">
              <ion-icon name="add-outline" slot="start"></ion-icon>
              Add History
            </ion-button>
          </div>

          <div class="card-content">
            <!-- Loading state -->
            <div *ngIf="isLoadingMedicalHistory" class="loading-state">
              <ion-skeleton-text animated style="width: 100%; height: 60px; margin-bottom: 10px;"></ion-skeleton-text>
              <ion-skeleton-text animated style="width: 80%; height: 40px; margin-bottom: 10px;"></ion-skeleton-text>
              <ion-skeleton-text animated style="width: 60%; height: 30px;"></ion-skeleton-text>
            </div>
            
            <!-- Data loaded state -->
            <div *ngIf="!isLoadingMedicalHistory && medicalHistory.length > 0">
              <div *ngFor="let history of (isMedicalHistoryExpanded ? medicalHistory : (medicalHistory | slice:0:3))" 
                   class="history-summary-card">
                <div class="history-summary-header">
                  <div class="history-summary-info">
                    <h4 class="history-condition">{{ history.condition }}</h4>
                    <p class="history-date">Diagnosed: {{ history.diagnosisDate | date:'MMM d, y' }}</p>
                  </div>
                  <div class="history-header-actions">
                    <ion-chip class="history-status-chip" size="small">
                      {{ history.status }}
                    </ion-chip>
                    <ion-button fill="clear" size="small" class="menu-toggle-btn history-menu-btn" (click)="presentHistoryActionsPopoverHandler($event, history); $event.stopPropagation()" #popoverTrigger>
                      <ion-icon name="ellipsis-vertical-outline" class="history-menu-icon"></ion-icon>
                    </ion-button>
                  </div>
                </div>
                <p class="history-notes" *ngIf="history.notes">{{ history.notes | slice:0:100 }}{{ history.notes.length > 100 ? '...' : '' }}</p>
                <div class="history-click-hint">
                  <ion-icon name="eye-outline" class="history-eye-icon"></ion-icon>
                  <a class="history-details-link" (click)="openMedicalHistoryDetailsHandler(history)">Click to view full details</a>
                </div>
              </div>
              
              <div *ngIf="medicalHistory.length > 3" class="view-all-link">
                <ion-button fill="clear" size="small" (click)="expandMedicalHistoryHandler()">
                  {{ isMedicalHistoryExpanded ? 'Show less' : 'View all ' + medicalHistory.length + ' conditions' }}
                  <ion-icon [name]="isMedicalHistoryExpanded ? 'chevron-up-outline' : 'chevron-down-outline'" slot="end"></ion-icon>
                </ion-button>
              </div>
            </div>

            <!-- No data state -->
            <div *ngIf="!isLoadingMedicalHistory && medicalHistory.length === 0" class="empty-state">
              <p class="empty-title">No medical history recorded</p>
              <p class="empty-subtitle">Document your medical conditions and diagnoses</p>
            </div>
          </div>
        </div>

        <app-ehr-access-management-card
          [ehrAccessList]="ehrAccessList"
          [newProviderEmail]="newProviderEmail"
          [newProviderName]="newProviderName"
          [newProviderRole]="newProviderRole"
          [newProviderLicense]="newProviderLicense"
          [newProviderSpecialty]="newProviderSpecialty"
          [newProviderHospital]="newProviderHospital"
          (sendAccessRequest)="sendAccessRequestHandler()"
          (revokeAccess)="revokeEHRAccessHandler($event)">
        </app-ehr-access-management-card>

      </ng-container>
