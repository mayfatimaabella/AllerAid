<ion-header>
  <ion-toolbar class="teal-modal-toolbar">
    <ion-title>{{ isEditMode ? 'Edit' : 'Add' }} Medication</ion-title>
    <ion-buttons slot="start">
      <ion-button (click)="dismiss()" fill="clear">
        <ion-icon name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-button (click)="dismiss()" fill="clear">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding white-content">
  <form (ngSubmit)="saveMedication()">
    <div class="form-fields">
      <ion-item class="medication-field" lines="none">
        <ion-label position="stacked">Name of Medication *</ion-label>
        <ion-input 
          [(ngModel)]="med.name" 
          name="name" 
          placeholder="e.g., Ibuprofen, Cetirizine"
          required>
        </ion-input>
      </ion-item>

      <!-- Structured Dosage Input (Amount + Unit) -->
      <div class="dosage-input-group">
        <ion-item class="medication-field dosage-amount-field" lines="none">
          <ion-label position="stacked">Dosage Amount *</ion-label>
          <ion-input 
            type="number" 
            [(ngModel)]="med.dosageAmount" 
            name="dosageAmount"
            placeholder="50"
            required>
          </ion-input>
        </ion-item>
        
        <ion-item class="medication-field dosage-unit-field" lines="none">
          <ion-label position="stacked">Unit *</ion-label>
          <ion-select 
            [(ngModel)]="med.dosageUnit" 
            name="dosageUnit"
            placeholder="Select unit"
            interface="popover"
            required>
            <ion-select-option value="mg">mg</ion-select-option>
            <ion-select-option value="mcg">mcg</ion-select-option>
            <ion-select-option value="g">g</ion-select-option>
            <ion-select-option value="mL">mL</ion-select-option>
            <ion-select-option value="L">L</ion-select-option>
            <ion-select-option value="tablet">tablet(s)</ion-select-option>
            <ion-select-option value="capsule">capsule(s)</ion-select-option>
            <ion-select-option value="pill">pill(s)</ion-select-option>
            <ion-select-option value="puff">puff(s)</ion-select-option>
            <ion-select-option value="drop">drop(s)</ion-select-option>
            <ion-select-option value="spray">spray(s)</ion-select-option>
            <ion-select-option value="IU">IU</ion-select-option>
            <ion-select-option value="tsp">tsp</ion-select-option>
            <ion-select-option value="tbsp">tbsp</ion-select-option>
            <ion-select-option value="patch">patch(es)</ion-select-option>
            <ion-select-option value="unit">unit(s)</ion-select-option>
          </ion-select>
        </ion-item>
      </div>
      <ion-note class="dosage-helper">
        <ion-icon name="information-circle-outline"></ion-icon>
        Example: 50 mg, 2 tablets, 5 mL
      </ion-note>

      <ion-item class="medication-field quantity-field" lines="none">
        <ion-label position="stacked">Number of Pills *</ion-label>
        <ion-input 
          [(ngModel)]="med.quantity" 
          name="quantity"
          type="number"
          min="1"
          max="999"
          step="1"
          placeholder="e.g., 30"
          inputmode="numeric"
          (ionBlur)="onQuantityChange()"
          required>
        </ion-input>
      </ion-item>

      <ion-item class="medication-field duration-field" lines="none">
        <ion-label position="stacked">
          Duration 
          <span class="optional-label">
            {{ isDurationManual ? '(Manual)' : '(Auto-calculated from dates)' }}
          </span>
        </ion-label>
        <div class="duration-input-container">
          <ion-input 
            [(ngModel)]="med.frequency" 
            name="frequency"
            [placeholder]="isDurationManual ? 'e.g., 10 days, 2 weeks' : 'Select start and expiry dates to auto-calculate'"
            [readonly]="!isDurationManual"
            (ionInput)="onDurationChange()">
          </ion-input>
          <ion-button 
            fill="clear" 
            size="small"
            (click)="toggleDurationMode()"
            [title]="isDurationManual ? 'Switch to auto-calculate' : 'Switch to manual input'">
            <ion-icon [name]="isDurationManual ? 'calculator-outline' : 'create-outline'"></ion-icon>
          </ion-button>
        </div>
      </ion-item>

      <!-- Start Date Field (Optional, defaults to today) -->
      <ion-item class="medication-field date-field" lines="none">
        <ion-label position="stacked">Start Date <span class="optional-label">(Optional)</span></ion-label>
        <ion-datetime-button datetime="startDate"></ion-datetime-button>
        <ion-modal [keepContentsMounted]="true">
          <ng-template>
            <ion-datetime 
              id="startDate"
              [(ngModel)]="med.startDate"
              name="startDate"
              presentation="date"
              [max]="todayISO"
              [showDefaultButtons]="true"
              doneText="Done"
              cancelText="Cancel"
              (ionChange)="onStartDateChange()">
            </ion-datetime>
          </ng-template>
        </ion-modal>
      </ion-item>

      <!-- Expiry Date Field (Optional) -->
      <ion-item class="medication-field date-field" lines="none">
        <ion-label position="stacked">Expiry Date <span class="optional-label">(Optional)</span></ion-label>
        <ion-datetime-button datetime="expiryDate"></ion-datetime-button>
        <ion-modal [keepContentsMounted]="true">
          <ng-template>
            <ion-datetime 
              id="expiryDate"
              [(ngModel)]="med.expiryDate"
              name="expiryDate"
              presentation="date"
              [min]="todayISO"
              [showDefaultButtons]="true"
              doneText="Done"
              cancelText="Cancel"
              (ionChange)="onExpiryDateChange()">
            </ion-datetime>
          </ng-template>
        </ion-modal>
      </ion-item>

      <ion-item class="medication-field notes-field" lines="none">
        <ion-label position="stacked">Notes</ion-label>
        <ion-textarea 
          [(ngModel)]="med.notes" 
          name="notes"
          rows="3"
          placeholder="Additional notes about the medication">
        </ion-textarea>
      </ion-item>

      <!-- Optional: Prescribed By -->
      <ion-item class="medication-field" lines="none">
        <ion-label position="stacked">Prescribed by <span class="optional-label">(Optional)</span></ion-label>
        <ion-input 
          [(ngModel)]="med.prescribedBy" 
          name="prescribedBy"
          placeholder="e.g., Dr. Jane Smith">
        </ion-input>
      </ion-item>

      <!-- Optional: Medication Type -->
      <ion-item class="medication-field" lines="none">
        <ion-label position="stacked">Type <span class="optional-label">(Optional)</span></ion-label>
        <ion-select 
          [(ngModel)]="med.medicationType" 
          name="medicationType"
          interface="popover"
          placeholder="Select type">
          <ion-select-option value="tablet">Tablet</ion-select-option>
          <ion-select-option value="capsule">Capsule</ion-select-option>
          <ion-select-option value="liquid">Liquid</ion-select-option>
          <ion-select-option value="injection">Injection</ion-select-option>
          <ion-select-option value="inhaler">Inhaler</ion-select-option>
          <ion-select-option value="cream">Cream</ion-select-option>
          <ion-select-option value="drops">Drops</ion-select-option>
          <ion-select-option value="patch">Patch</ion-select-option>
          <ion-select-option value="other">Other</ion-select-option>
        </ion-select>
      </ion-item>

      <!-- Optional: Route -->
      <ion-item class="medication-field" lines="none">
        <ion-label position="stacked">Route <span class="optional-label">(Optional)</span></ion-label>
        <ion-select 
          [(ngModel)]="med.route" 
          name="route"
          interface="popover"
          placeholder="Select route">
          <ion-select-option value="oral">Oral</ion-select-option>
          <ion-select-option value="topical">Topical</ion-select-option>
          <ion-select-option value="injection">Injection</ion-select-option>
          <ion-select-option value="inhalation">Inhalation</ion-select-option>
          <ion-select-option value="nasal">Nasal</ion-select-option>
          <ion-select-option value="ophthalmic">Ophthalmic</ion-select-option>
          <ion-select-option value="otic">Otic</ion-select-option>
        </ion-select>
      </ion-item>
    </div>

    <!-- Prescription Image Section -->
    <div class="image-section">
      <div class="section-header">
        <ion-icon name="image-outline" class="section-icon"></ion-icon>
        <div class="section-info">
          <h3>Prescription Image</h3>
          <p>Add a photo of your prescription for reference</p>
        </div>
      </div>
      
      <ion-button 
        fill="outline" 
        color="primary"
        (click)="selectPrescriptionImage()"
        class="image-upload-btn">
        <ion-icon name="camera-outline" slot="start"></ion-icon>
        Add Prescription Photo
      </ion-button>
      
      <div *ngIf="prescriptionImage" class="image-preview">
        <img [src]="prescriptionImage" alt="Prescription">
        <ion-button 
          fill="clear" 
          color="danger" 
          (click)="removePrescriptionImage()"
          class="remove-image-btn">
          <ion-icon name="close-circle" slot="icon-only"></ion-icon>
        </ion-button>
      </div>
    </div>

    <div class="action-buttons">
      <ion-button 
        expand="block" 
        type="submit" 
        color="primary"
        [disabled]="!isFormValid">
        <ion-icon [name]="isEditMode ? 'checkmark-outline' : 'add-outline'" slot="start"></ion-icon>
        {{ isEditMode ? 'Update Medication' : 'Save Medication' }}
      </ion-button>
      
      <ion-button 
        expand="block" 
        fill="outline" 
        color="medium"
        (click)="dismiss()">
        <ion-icon name="close-outline" slot="start"></ion-icon>
        Cancel
      </ion-button>
    </div>
  </form>
</ion-content>
