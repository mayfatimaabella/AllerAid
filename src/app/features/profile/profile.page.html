<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Profile</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="profile-header">
    <ion-avatar class="profile-avatar">
      <img alt="person-avatar" src="https://ionicframework.com/docs/img/demos/avatar.svg" />
    </ion-avatar>
    <div class="profile-name">{{ getEmergencyMessageName() }}</div>

  </div>

  <div class="profile-card">
    <!-- Patient Profile Stats -->
    <div class="profile-stats" *ngIf="userProfile?.role === 'user'">
      <div class="stat">
        <div class="stat-label">Allergies</div>
        <div class="stat-value">{{ allergiesCount }}</div>
      </div>
      <div class="stat">
        <div class="stat-label">Medications</div>
        <div class="stat-value">{{ medicationsCount }}</div>
      </div>
      <div class="stat">
        <div class="stat-label">Buddies</div>
        <div class="stat-value">{{ buddiesCount }}</div>
      </div>
    </div>

    <!-- Buddy Profile Stats -->
    <div class="profile-stats" *ngIf="userProfile?.role === 'buddy'">
      <div class="stat">
        <div class="stat-label">Protected Patients</div>
        <div class="stat-value">{{ buddyStats.protectedPatients }}</div>
      </div>
      <div class="stat">
        <div class="stat-label">Emergency Responses</div>
        <div class="stat-value">{{ buddyStats.emergencyResponses }}</div>
      </div>
      <div class="stat">
        <div class="stat-label">Invitations</div>
        <div class="stat-value">{{ buddyStats.invitations }}</div>
      </div>
    </div>

    <!-- Patient Profile Tabs -->
    <div class="profile-tabs" *ngIf="userProfile?.role === 'user'">
      <button class="tab" [class.active]="selectedTab === 'overview'" (click)="selectTab('overview')">Overview</button>
      <button class="tab" [class.active]="selectedTab === 'health'" (click)="selectTab('health')">Health</button>
      <button class="tab" [class.active]="selectedTab === 'ehr'" (click)="selectTab('ehr')">EHR</button>
      <button class="tab" [class.active]="selectedTab === 'emergency'" (click)="selectTab('emergency')">Emergency</button>
    </div>

    <!-- Doctor Profile Tabs - Managed by DoctorProfileComponent -->

    <!-- Buddy Profile Tabs -->
    <div class="profile-tabs" *ngIf="userProfile?.role === 'buddy'">
      <button class="tab" [class.active]="selectedTab === 'dashboard'" (click)="selectTab('dashboard')">Dashboard</button>
      <button class="tab" [class.active]="selectedTab === 'patients'" (click)="selectTab('patients')">My Patients</button>
      <button class="tab" [class.active]="selectedTab === 'emergency'" (click)="selectTab('emergency')">Emergency</button>
      <button class="tab" [class.active]="selectedTab === 'settings'" (click)="selectTab('settings')">Settings</button>
    </div>


    <!--PROFILE SECTION | OVERVIEW-->
    <div class="profile-section">
      <!-- PATIENT PROFILE CONTENT -->
      <div *ngIf="userProfile?.role === 'user'">
        <ng-container *ngIf="selectedTab === 'overview'">
          <app-profile-overview-section
            [userAllergies]="userAllergies"
            [emergencyMessageName]="getEmergencyMessageName()"
            [emergencyInstructionsCombined]="getEmergencyInstructionsCombined()"
            [emergencyLocation]="getEmergencyMessageLocation()"
            [showManageInstructionsModal]="showManageInstructionsModal"
            [emergencyInstructions]="emergencyInstructions"
            [selectedInstructionDetails]="selectedInstructionDetails"
            [showInstructionDetailsModal]="showInstructionDetailsModal"
            (openEditAllergies)="openEditAllergiesModal()"
            (openEmergencyInfo)="openEmergencyInfoModal()"
            (closeManageInstructions)="showManageInstructionsModal = false"
            (addInstruction)="loadEmergencyInstructions()"
            (updateInstruction)="loadEmergencyInstructions()"
            (removeInstruction)="loadEmergencyInstructions()"
            (editInstruction)="loadEmergencyInstructions()"
            (cancelEdit)="showManageInstructionsModal = false"
            (showDetails)="showInstructionDetails($event)">
          </app-profile-overview-section>
        </ng-container>

      <!-- PROFILE SECTION | HEALTH TAB CONTENT -->
      <ng-container *ngIf="selectedTab === 'health'">
        <app-profile-health-section
          [userMedications]="userMedications"
          [filteredMedications]="filteredMedications"
          [medicationFilter]="$any(medicationFilter)"
          [medicationSearchTerm]="medicationSearchTerm"
          [isLoading]="isLoadingMedications"
          [isEmergencyMedicationFn]="isEmergencyMedicationBind"
          [isMedicationDetailsExpandedFn]="isMedicationDetailsExpandedBind"
          [isExpiringSoonFn]="isExpiringSoonBind"
          [getMedicationTypeLabelFn]="getMedicationTypeLabelBind"
          [getRouteLabelFn]="getRouteLabelBind"
          (add)="openAddMedicationModal()"
          (search)="searchMedications($event)"
          (clearSearch)="clearMedicationSearch()"
          (medicationFilterChange)="medicationFilter = $event; filterMedications()"
          (toggleDetails)="toggleMedicationDetails($event)"
          (toggleStatus)="toggleMedicationStatus($event)"
          (edit)="editMedication($event)"
          (delete)="deleteMedication($event)"
          (viewImage)="viewMedicationImage($event.url, $event.title)"
          (viewDetails)="openMedicationDetails($event)"
        ></app-profile-health-section>
      </ng-container>

      <ng-container *ngIf="selectedTab === 'ehr'">
        <div class="ehr-header">
          <h2>Electronic Health Record</h2>
          <p class="ehr-subtitle">Manage your medical information and provider access</p>
        </div>

        <!-- Doctor Visits Card -->
        <div class="ehr-section-card">
          <div class="card-header">
            <div class="card-title">
              <ion-icon name="medical-outline" color="primary"></ion-icon>
              <h3>Doctor Visits</h3>
            </div>
            <ion-button size="small" fill="clear" (click)="openAddDoctorVisitModal()">
              <ion-icon name="add-outline" slot="start"></ion-icon>
              Add Visit
            </ion-button>
          </div>

          <div class="card-content">
            <!-- Loading state -->
            <div *ngIf="isLoadingDoctorVisits" class="loading-state">
              <ion-skeleton-text animated style="width: 100%; height: 60px; margin-bottom: 10px;"></ion-skeleton-text>
              <ion-skeleton-text animated style="width: 80%; height: 40px; margin-bottom: 10px;"></ion-skeleton-text>
              <ion-skeleton-text animated style="width: 60%; height: 30px;"></ion-skeleton-text>
            </div>
            
            <!-- Content when not loading -->
            <div *ngIf="!isLoadingDoctorVisits">
              <!-- Data loaded state -->
              <div *ngIf="doctorVisits.length > 0">
                <div *ngFor="let visit of (isDoctorVisitsExpanded ? doctorVisits : (doctorVisits | slice:0:3))" 
                     class="visit-summary-card" 
                     (click)="openVisitDetails(visit)">
                  <div class="visit-summary-header">
                    <div class="visit-summary-info">
                      <h4>{{ visit.doctorName }}</h4>
                      <p class="visit-date">{{ visit.visitDate | date:'mediumDate' }}</p>
                    </div>
                    <div class="visit-header-actions">
                      <ion-chip [color]="getVisitTypeColor(visit.visitType)" size="small">
                        {{ getVisitTypeLabel(visit.visitType) }}
                      </ion-chip>
                      <ion-button 
                        fill="clear" 
                        size="small" 
                        class="menu-toggle-btn"
                        (click)="presentVisitActionsPopover($event, visit); $event.stopPropagation()">
                        <ion-icon name="ellipsis-vertical-outline"></ion-icon>
                      </ion-button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- No doctor visits message -->
              <div *ngIf="doctorVisits.length === 0" class="no-data">
                <p>No doctor visits recorded yet</p>
              </div>
            </div>
          </div>
        </div>

         <!-- Medical History Card -->
        <div class="ehr-section-card">
          <div class="card-header">
            <div class="card-title">
              <ion-icon name="document-text-outline" color="secondary"></ion-icon>
              <h3>Medical History</h3>
            </div>
            <ion-button size="small" fill="clear" (click)="openAddMedicalHistoryModal()">
              <ion-icon name="add-outline" slot="start"></ion-icon>
              Add Condition
            </ion-button>
          </div>

          <div class="card-content">
            <!-- Loading state -->
            <div *ngIf="isLoadingMedicalHistory" class="loading-state">
              <ion-skeleton-text animated style="width: 100%; height: 60px; margin-bottom: 10px;"></ion-skeleton-text>
              <ion-skeleton-text animated style="width: 80%; height: 40px; margin-bottom: 10px;"></ion-skeleton-text>
              <ion-skeleton-text animated style="width: 60%; height: 30px;"></ion-skeleton-text>
            </div>
            
            <!-- Data loaded state -->
            <div *ngIf="!isLoadingMedicalHistory && medicalHistory.length > 0">
              <div *ngFor="let history of (isMedicalHistoryExpanded ? medicalHistory : (medicalHistory | slice:0:3))" 
                   class="history-summary-card" 
                   (click)="openMedicalHistoryDetails(history)">
                <div class="history-summary-header">
                  <div class="history-summary-info">
                    <h4>{{ history.condition }}</h4>
                    <p class="history-date">Diagnosed: {{ history.diagnosisDate | date:'mediumDate' }}</p>
                  </div>
                  <div class="history-header-actions">
                    <ion-chip [color]="getHistoryStatusColor(history.status)" size="small">
                      {{ history.status }}
                    </ion-chip>
                    <ion-button 
                      fill="clear" 
                      size="small" 
                      class="menu-toggle-btn"
                      (click)="presentHistoryActionsPopover($event, history); $event.stopPropagation()"
                      #popoverTrigger>
                      <ion-icon name="ellipsis-vertical-outline"></ion-icon>
                    </ion-button>
                  </div>
                </div>
                <p class="history-notes" *ngIf="history.notes">{{ history.notes | slice:0:100 }}{{ history.notes.length > 100 ? '...' : '' }}</p>
                <div class="history-click-hint">
                  <ion-icon name="eye-outline"></ion-icon>
                  <span>Click to view full details</span>
                </div>
              </div>
              
              <div *ngIf="medicalHistory.length > 3" class="view-all-link">
                <ion-button fill="clear" size="small" (click)="expandMedicalHistory()">
                  {{ isMedicalHistoryExpanded ? 'Show less' : 'View all ' + medicalHistory.length + ' conditions' }}
                  <ion-icon [name]="isMedicalHistoryExpanded ? 'chevron-up-outline' : 'chevron-down-outline'" slot="end"></ion-icon>
                </ion-button>
              </div>
            </div>

            <!-- No data state -->
            <div *ngIf="!isLoadingMedicalHistory && medicalHistory.length === 0" class="empty-state">
              <ion-icon name="document-text-outline" class="empty-icon"></ion-icon>
              <p class="empty-title">No medical history recorded</p>
              <p class="empty-subtitle">Document your medical conditions and diagnoses</p>
              <ion-button fill="outline" size="small" (click)="openAddMedicalHistoryModal()">
                <ion-icon name="add-outline" slot="start"></ion-icon>
                Add Condition
              </ion-button>
            </div>
          </div>
        </div>

        <!-- EHR Access Management Card -->
        <div class="ehr-section-card">
          <div class="card-header">
            <div class="card-title">
              <ion-icon name="people-outline" color="tertiary"></ion-icon>
              <h3>Provider Access</h3>
            </div>
          </div>

          <div class="card-content">
            <p class="access-description">Send access requests to verified healthcare providers for coordinated care.</p>
            
            <div class="add-provider-section">
              <ion-item lines="none" class="provider-input">
                <ion-label position="stacked">Provider Email</ion-label>
                <ion-input 
                  [(ngModel)]="newProviderEmail" 
                  placeholder="doctor@example.com"
                  type="email">
                </ion-input>
              </ion-item>
              
              <ion-item lines="none" class="provider-input">
                <ion-label position="stacked">Provider Name</ion-label>
                <ion-input 
                  [(ngModel)]="newProviderName" 
                  placeholder="Dr. Sarah Johnson">
                </ion-input>
              </ion-item>
              
              <ion-item lines="none" class="provider-input">
                <ion-label position="stacked">Provider Role</ion-label>
                <ion-select [(ngModel)]="newProviderRole" interface="popover">
                  <ion-select-option value="doctor">Doctor</ion-select-option>
                  <ion-select-option value="nurse">Nurse</ion-select-option>
                </ion-select>
              </ion-item>
              
              <!-- Optional Fields -->
              <ion-item lines="none" class="provider-input">
                <ion-label position="stacked">License Number <span class="optional-label">(Optional)</span></ion-label>
                <ion-input 
                  [(ngModel)]="newProviderLicense" 
                  placeholder="e.g., MD12345">
                </ion-input>
              </ion-item>
              
              <ion-item lines="none" class="provider-input">
                <ion-label position="stacked">Specialty <span class="optional-label">(Optional)</span></ion-label>
                <ion-input 
                  [(ngModel)]="newProviderSpecialty" 
                  placeholder="e.g., Cardiology, Family Medicine">
                </ion-input>
              </ion-item>
              
              <ion-item lines="none" class="provider-input">
                <ion-label position="stacked">Hospital/Clinic <span class="optional-label">(Optional)</span></ion-label>
                <ion-input 
                  [(ngModel)]="newProviderHospital" 
                  placeholder="e.g., City General Hospital">
                </ion-input>
              </ion-item>
              
              <ion-button 
                expand="block" 
                fill="solid" 
                (click)="sendAccessRequest()"
                [disabled]="!newProviderEmail || !newProviderName">
                <ion-icon name="paper-plane-outline" slot="start"></ion-icon>
                Send Access Request
              </ion-button>
              
              <p class="help-text">
                <ion-icon name="information-circle-outline"></ion-icon>
                The provider must be registered in the system and will need to accept your request.
              </p>
            </div>

            <div class="current-access" *ngIf="ehrAccessList.length > 0">
              <h4>Current Provider Access</h4>
              <div class="access-list">
                <div *ngFor="let provider of ehrAccessList" class="access-item">
                  <div class="provider-info">
                    <ion-icon name="person-outline"></ion-icon>
                    <span>{{ provider }}</span>
                  </div>
                  <ion-button 
                    fill="clear" 
                    color="danger" 
                    size="small"
                    (click)="revokeEHRAccess(provider)">
                    <ion-icon name="trash-outline"></ion-icon>
                  </ion-button>
                </div>
              </div>
            </div>

            <div *ngIf="ehrAccessList.length === 0" class="no-access">
              <p class="empty-subtitle">No providers have access to your EHR</p>
            </div>
          </div>
        </div>

        <!-- Professional Workflow Access -->
        <div class="ehr-section-card" 
          *ngIf="userProfile?.role === 'doctor'">
          <div class="card-header">
            <div class="card-title">
              <ion-icon name="medical-outline" color="primary"></ion-icon>
              <h3>Professional Features</h3>
            </div>
          </div>
          
          <div class="card-content">
            <p class="access-description">Access advanced professional workflow features for healthcare providers.</p>
            
            <ion-chip color="primary" style="margin-bottom: 16px;">
              <ion-icon name="medical-outline"></ion-icon>
              <ion-label>Doctor Access</ion-label>
            </ion-chip>
            
            <ion-button 
              expand="block" 
              fill="outline" 
              color="primary"
              (click)="navigateToDoctorDashboard()">
              <ion-icon name="medical-outline" slot="start"></ion-icon>
              Doctor Dashboard
            </ion-button>

            <!-- Access Requests Section for Healthcare Providers -->
            <div *ngIf="pendingRequests.length > 0" style="margin-top: 20px;">
              <h4>Pending Access Requests ({{ pendingRequests.length }})</h4>
              
              <div *ngFor="let request of pendingRequests" class="access-request-card">
                <div class="request-header">
                  <div class="patient-info">
                    <strong>{{ request.patientName }}</strong>
                    <div class="patient-email">{{ request.patientEmail }}</div>
                  </div>
                  <ion-chip color="warning" size="small">
                    <ion-icon name="time-outline"></ion-icon>
                    <ion-label>{{ getRequestAge(request.requestDate) }}</ion-label>
                  </ion-chip>
                </div>

                <p class="request-message">{{ request.message }}</p>

                <div class="request-actions">
                  <ion-button 
                    size="small" 
                    fill="solid" 
                    color="success"
                    (click)="acceptAccessRequest(request)">
                    <ion-icon name="checkmark-outline" slot="start"></ion-icon>
                    Accept
                  </ion-button>
                  
                  <ion-button 
                    size="small" 
                    fill="outline" 
                    color="danger"
                    (click)="declineAccessRequest(request)">
                    <ion-icon name="close-outline" slot="start"></ion-icon>
                    Decline
                  </ion-button>
                </div>
              </div>
            </div>

            <div *ngIf="pendingRequests.length === 0" class="no-access">
              <p class="empty-subtitle">No pending access requests</p>
            </div>
          </div>
        </div>
      </ng-container>

      <ng-container *ngIf="selectedTab === 'emergency'">
        <div class="emergency-settings-title">Emergency Settings</div>

        <div class="emergency-setting-card">
          <div class="emergency-setting-info">
            <div class="emergency-setting-title">Shake to Alert</div>
            <div class="emergency-setting-desc">Shake phone to trigger emergency</div>
          </div>
          <ion-toggle [(ngModel)]="emergencySettings.shakeToAlert" (ionChange)="saveEmergencySettings()"></ion-toggle>
        </div>

        <div class="emergency-setting-card">
          <div class="emergency-setting-info">
            <div class="emergency-setting-title">Power Button Alert</div>
            <div class="emergency-setting-desc">Press power button 3 times</div>
          </div>
          <ion-toggle [(ngModel)]="emergencySettings.powerButtonAlert" (ionChange)="saveEmergencySettings()"></ion-toggle>
        </div>

        <div class="emergency-setting-card">
          <div class="emergency-setting-info">
            <div class="emergency-setting-title">Audio Instructions</div>
            <div class="emergency-setting-desc">Play emergency message aloud</div>
            <div class="emergency-setting-status" *ngIf="emergencySettings.audioInstructions">
              <span [class]="getAudioSourceClass()">{{ getAudioSourceText() }}</span>
            </div>
          </div>
          <div class="emergency-setting-actions">
            <ion-button *ngIf="emergencySettings.audioInstructions" 
                        (click)="openVoiceRecordingModal()" 
                        fill="clear" 
                        size="small"
                        [color]="showVoiceSettings ? 'primary' : 'medium'">
              <ion-icon name="mic-outline" slot="icon-only"></ion-icon>
            </ion-button>
            <ion-toggle [(ngModel)]="emergencySettings.audioInstructions" (ionChange)="saveEmergencySettings()"></ion-toggle>
          </div>
        </div>

        <!-- BEGIN: Allergy-Specific Emergency Instructions & Emergency Message / Testing (Inserted) -->
        <div class="emergency-instructions-display">
          <div class="instructions-section-header">Allergy-Specific Emergency Instructions</div>
          <div class="instructions-list-scrollable">
            <div *ngFor="let instruction of emergencyInstructions" 
                 class="instruction-card decluttered clickable" 
                 (click)="showInstructionDetails(instruction)">
              <div class="instruction-header">
                <ion-icon name="alert-circle-outline" style="color:#036a5d; font-size:20px; margin-right:8px;"></ion-icon>
                <strong>{{ instruction.allergyName }}</strong>
                <ion-icon name="chevron-forward-outline" style="color:#666; font-size:16px; margin-left:auto;"></ion-icon>
              </div>
              <div class="instruction-text">
                {{ instruction.instruction | slice:0:100 }}{{ instruction.instruction.length > 100 ? '...' : '' }}
              </div>
            </div>
            <div *ngIf="emergencyInstructions.length === 0" class="no-instructions-card decluttered">
              <p style="text-align: center; color: #666; font-style: italic;">
                No emergency instructions set.
              </p>
            </div>
          </div>
        </div>

        <!-- Emergency Instruction Details Modal (Replaced with user-provided layout) -->
        <ion-modal [isOpen]="showInstructionDetailsModal" (didDismiss)="showInstructionDetailsModal = false">
          <ng-template>
            <ion-header>
              <ion-toolbar>
                <ion-title>Emergency Instruction Details</ion-title>
                <ion-buttons slot="start">
                  <ion-button (click)="showInstructionDetailsModal = false" fill="clear">
                    <ion-icon name="arrow-back-outline"></ion-icon>
                  </ion-button>
                </ion-buttons>
                <ion-buttons slot="end">
                  <ion-button (click)="showInstructionDetailsModal = false" fill="clear">
                    <ion-icon name="close"></ion-icon>
                  </ion-button>
                </ion-buttons>
              </ion-toolbar>
            </ion-header>
            <ion-content class="ion-padding" *ngIf="selectedInstructionDetails">
              <div class="instruction-details-container">
                <div class="detail-section">
                  <div class="detail-header">
                    <ion-icon name="warning-outline" color="danger"></ion-icon>
                    <h3>Allergy Information</h3>
                  </div>
                  <div class="detail-content">
                    <div class="detail-row">
                      <span class="detail-label">Allergy:</span>
                      <span class="detail-value">{{ selectedInstructionDetails.allergyName }}</span>
                    </div>
                    <div class="detail-row" *ngIf="selectedInstructionDetails.allergyId !== selectedInstructionDetails.allergyName">
                      <span class="detail-label">ID:</span>
                      <span class="detail-value">{{ selectedInstructionDetails.allergyId }}</span>
                    </div>
                  </div>
                </div>
                <div class="detail-section">
                  <div class="detail-header">
                    <ion-icon name="medical-outline" color="primary"></ion-icon>
                    <h3>Emergency Instructions</h3>
                  </div>
                  <div class="detail-content">
                    <div class="instruction-full-text">
                      {{ selectedInstructionDetails.instruction }}
                    </div>
                  </div>
                </div>
                <div class="detail-section">
                  <div class="detail-header">
                    <ion-icon name="settings-outline" color="medium"></ion-icon>
                    <h3>Quick Actions</h3>
                  </div>
                  <div class="detail-content">
                    <div class="action-buttons-grid">
                      <ion-button expand="block" fill="outline" color="primary" (click)="editInstructionFromDetails()">
                        <ion-icon name="create-outline" slot="start"></ion-icon>
                        Edit Instruction
                      </ion-button>
                      <ion-button expand="block" fill="outline" color="success" (click)="testInstructionAudio()">
                        <ion-icon name="volume-high-outline" slot="start"></ion-icon>
                        Test Audio
                      </ion-button>
                      <ion-button expand="block" fill="outline" color="warning" (click)="shareInstruction()">
                        <ion-icon name="share-outline" slot="start"></ion-icon>
                        Share
                      </ion-button>
                      <ion-button expand="block" fill="outline" color="danger" (click)="confirmDeleteInstruction()">
                        <ion-icon name="trash-outline" slot="start"></ion-icon>
                        Delete
                      </ion-button>
                    </div>
                  </div>
                </div>
                <div class="detail-section">
                  <div class="detail-header">
                    <ion-icon name="information-circle-outline" color="tertiary"></ion-icon>
                    <h3>Usage Tips</h3>
                  </div>
                  <div class="detail-content">
                    <ul class="tips-list">
                      <li>This instruction will be read aloud during emergencies if audio is enabled</li>
                      <li>First responders and emergency contacts will see this information</li>
                      <li>Keep instructions clear and specific to this allergy</li>
                      <li>Include medication locations and emergency contact numbers</li>
                    </ul>
                  </div>
                </div>
              </div>
            </ion-content>
          </ng-template>
        </ion-modal>

        <div class="emergency-message-title" style="display:flex; align-items:center; gap:8px;">
          <span>Emergency Message</span>
          <ion-button size="small" fill="clear" color="primary" (click)="openEditEmergencyMessageModal()" style="margin-left:auto;">
            <ion-icon name="create-outline" slot="start"></ion-icon>
            Edit
          </ion-button>
        </div>

        <div class="emergency-instructions-display">
          <div class="instructions-section-header" style="display:flex; align-items:center; gap:8px;">
            <span>Emergency Contact Information</span>
            <ion-button size="small" fill="clear" color="primary" (click)="openEditEmergencyMessageModal()" style="margin-left:auto;">
              <ion-icon name="create-outline" slot="start"></ion-icon>
              Edit
            </ion-button>
          </div>
          <div class="instructions-list-scrollable">
            <div class="emergency-message-card decluttered">
              <div class="emergency-message-row">
                <div class="emergency-message-label">Name:</div>
                <div class="emergency-message-value">{{ getEmergencyMessageName() }}</div>
              </div>
              <div class="emergency-message-row">
                <div class="emergency-message-label">Allergies:</div>
                <div class="emergency-message-value">{{ getEmergencyMessageAllergies() }}</div>
              </div>
              <div class="emergency-message-row">
                <div class="emergency-message-label">Instructions:</div>
                <div class="emergency-message-value">{{ getEmergencyInstructionsCombined() }}</div>
              </div>
              <div class="emergency-message-row">
                <div class="emergency-message-label">Location:</div>
                <div class="emergency-message-value">{{ getEmergencyMessageLocation() }}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="emergency-testing-title">Emergency Alert Testing</div>
        
        <div class="emergency-test-buttons">
          <ion-button expand="block" fill="outline" color="warning" (click)="testEmergencyAlert()">
            <ion-icon name="warning-outline" slot="start"></ion-icon>
            Test Emergency Alert (Manual)
          </ion-button>
          
          <ion-button expand="block" fill="outline" color="primary" (click)="testShakeDetection()">
            <ion-icon name="phone-portrait-outline" slot="start"></ion-icon>
            Test Shake Detection
          </ion-button>

          <ion-button expand="block" fill="outline" color="secondary" (click)="testPowerButtonDetection()">
            <ion-icon name="power-outline" slot="start"></ion-icon>
            Test Power Button Detection
          </ion-button>

          <ion-button expand="block" fill="outline" color="tertiary" (click)="testAudioInstructions()">
            <ion-icon name="volume-high-outline" slot="start"></ion-icon>
            Test Audio Instructions
          </ion-button>

          <ion-button expand="block" fill="outline" color="medium" (click)="requestMotionPermissions()">
            <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
            Request Motion Permissions
          </ion-button>

          <ion-button expand="block" fill="outline" color="success" (click)="showEmergencyExamples()">
            <ion-icon name="book-outline" slot="start"></ion-icon>
            View Examples & Tips
          </ion-button>
        </div>

        <!-- Emergency Examples Modal -->
        <ion-modal [isOpen]="showExamplesModal" (didDismiss)="showExamplesModal = false">
          <ng-template>
            <ion-header>
              <ion-toolbar>
                <ion-title>Emergency Instruction Examples</ion-title>
                <ion-buttons slot="start">
                  <ion-button (click)="showExamplesModal = false" fill="clear">
                    <ion-icon name="arrow-back-outline"></ion-icon>
                  </ion-button>
                </ion-buttons>
                <ion-buttons slot="end">
                  <ion-button (click)="showExamplesModal = false" fill="clear">
                    <ion-icon name="close"></ion-icon>
                  </ion-button>
                </ion-buttons>
              </ion-toolbar>
            </ion-header>
            <ion-content class="ion-padding">
              <div class="examples-container">
                <div class="example-section">
                  <h3>Simple Examples:</h3>
                  <div class="example-card">
                    <p>"I have a severe peanut allergy. Use my EpiPen and call 911 immediately."</p>
                    <ion-icon name="information-circle-outline" color="primary"></ion-icon>
                  </div>
                  
                  <div class="example-card">
                    <p>"Give me an antihistamine (Cetirizine) if I'm having trouble breathing."</p>
                    <ion-icon name="information-circle-outline" color="primary"></ion-icon>
                  </div>
                  
                  <div class="example-card">
                    <p>"I'm allergic to shellfish. If I faint or have hives, use the auto-injector in my bag."</p>
                    <ion-icon name="information-circle-outline" color="primary"></ion-icon>
                  </div>
                </div>

                <div class="example-section">
                  <h3>Detailed Instructions:</h3>
                  <div class="example-card">
                    <p>"This person is allergic to peanuts. If they are having trouble breathing, give them an EpiPen (in left pocket) immediately. Call emergency services (911). Stay with them until help arrives."</p>
                    <ion-icon name="information-circle-outline" color="primary"></ion-icon>
                  </div>
                </div>

                <div class="example-section">
                  <h3>With Medication Details:</h3>
                  <div class="example-card">
                    <p>"I'm allergic to bee stings. If I collapse or stop responding, inject my EpiPen in the thigh and call emergency services. I also carry Benadryl in my pouch."</p>
                    <ion-icon name="information-circle-outline" color="primary"></ion-icon>
                  </div>
                </div>

                <div class="example-section">
                  <h3>For Children/Elderly:</h3>
                  <div class="example-card">
                    <p>"Child has a dairy allergy. If symptoms like vomiting or hives appear, administer antihistamine syrup. If breathing difficulty occurs, use EpiPen and call emergency help."</p>
                    <ion-icon name="information-circle-outline" color="primary"></ion-icon>
                  </div>
                </div>

                <div class="tips-section">
                  <h3>Tips for Writing Instructions:</h3>
                  <ul>
                    <li>Be specific about your allergies</li>
                    <li>Include medication names and locations</li>
                    <li>Mention emergency contact numbers</li>
                    <li>Keep instructions clear and concise</li>
                    <li>Test audio playback regularly</li>
                  </ul>
                </div>
              </div>
            </ion-content>
          </ng-template>
        </ion-modal>
        <!-- END: Inserted Emergency Instructions / Message / Testing -->

        <!-- Voice Recording Settings (Expandable) -->
        <div class="voice-settings-section" *ngIf="emergencySettings.audioInstructions && showVoiceSettings">
          <!-- Recording Controls -->
          <div class="voice-recording-controls">
            <h4>Record Custom Voice</h4>
            <p>Record your own voice for emergency instructions</p>
            
            <div class="recording-zone" [class.recording]="isRecording">
              <div class="recording-status">
                <ion-icon [name]="isRecording ? 'mic' : 'mic-outline'"></ion-icon>
                <span *ngIf="!isRecording">Ready to Record</span>
                <span *ngIf="isRecording">Recording... {{ formatDuration(recordingTime) }}</span>
              </div>
              
              <div class="recording-buttons">
                <ion-button *ngIf="!isRecording" 
                            (click)="startRecording()" 
                            color="danger" 
                            fill="solid">
                  <ion-icon name="mic" slot="start"></ion-icon>
                  Start Recording
                </ion-button>
                
                <ion-button *ngIf="isRecording" 
                            (click)="stopRecording()" 
                            color="success" 
                            fill="solid">
                  <ion-icon name="stop" slot="start"></ion-icon>
                  Stop Recording
                </ion-button>
              </div>
            </div>
          </div>

          <!-- Recordings List -->
          <div class="voice-recordings-list" *ngIf="recordings.length > 0">
            <h4>Your Recordings</h4>
            <div class="recording-item" *ngFor="let recording of recordings">
              <div class="recording-info">
                <div class="recording-name">
                  <span>{{ recording.name }}</span>
                  <ion-icon *ngIf="isRecordingSelected(recording.id)" 
                            name="checkmark-circle" 
                            color="success"></ion-icon>
                </div>
                <div class="recording-details">
                  <span>{{ formatDuration(recording.duration) }}</span>
                  <span>{{ formatFileSize(recording.size) }}</span>
                </div>
              </div>
              <div class="recording-actions">
                <ion-button (click)="playRecording(recording.id)" 
                            fill="clear" 
                            size="small">
                  <ion-icon name="play" slot="icon-only"></ion-icon>
                </ion-button>
                <ion-button (click)="selectRecording(recording.id)" 
                            fill="clear" 
                            size="small"
                            [color]="isRecordingSelected(recording.id) ? 'success' : 'medium'">
                  <ion-icon name="checkmark" slot="icon-only"></ion-icon>
                </ion-button>
                <ion-button (click)="deleteRecording(recording)" 
                            fill="clear" 
                            size="small" 
                            color="danger">
                  <ion-icon name="trash" slot="icon-only"></ion-icon>
                </ion-button>
              </div>
            </div>
          </div>

          <!-- Audio Settings -->
          <div class="voice-audio-settings">
            <h4>Audio Settings</h4>
            
            <div class="setting-item">
              <div class="setting-info">
                <label>Use Custom Voice</label>
                <p>Play your recorded message instead of text-to-speech</p>
              </div>
              <ion-toggle [(ngModel)]="audioSettings.useCustomVoice" 
                          (ionChange)="onAudioSettingChange()"></ion-toggle>
            </div>

            <div class="setting-item" *ngIf="!audioSettings.useCustomVoice">
              <div class="setting-info">
                <label>Default Voice</label>
                <p>Choose text-to-speech voice type</p>
              </div>
              <ion-select [(ngModel)]="audioSettings.defaultVoice" 
                          (ionChange)="onAudioSettingChange()"
                          interface="popover">
                <ion-select-option value="female">Female</ion-select-option>
                <ion-select-option value="male">Male</ion-select-option>
              </ion-select>
            </div>

            <div class="setting-item">
              <div class="setting-info">
                <label>Speech Rate ({{ audioSettings.speechRate }}x)</label>
                <p>How fast the audio plays</p>
              </div>
              <ion-range [(ngModel)]="audioSettings.speechRate"
                         (ionChange)="onAudioSettingChange()"
                         min="0.5"
                         max="2.0"
                         step="0.1"
                         pin="true">
              </ion-range>
            </div>

            <div class="setting-item">
              <div class="setting-info">
                <label>Volume ({{ (audioSettings.volume * 100).toFixed(0) }}%)</label>
                <p>Audio playback volume</p>
              </div>
              <ion-range [(ngModel)]="audioSettings.volume"
                         (ionChange)="onAudioSettingChange()"
                         min="0"
                         max="1"
                         step="0.1"
                         pin="true">
              </ion-range>
            </div>

            <ion-button (click)="testAudioInstructions()" 
                        expand="block" 
                        fill="outline" 
                        color="secondary">
              <ion-icon name="volume-high" slot="start"></ion-icon>
              Test Audio Settings
            </ion-button>
          </div>
        </div>
      </ng-container>
    </div>
    <!-- End Patient Profile Content -->

     <!-- Emergency Instructions Modal (separated component)
       Contract with `app-emergency-specific-instructions-modal`:
       Inputs: [emergencyInstructions], [userAllergies]
       Outputs handled here: (addInstruction),(updateInstruction),(removeInstruction),(editInstruction),(cancelEdit),(showDetails),(close)
       Parent opens this modal by setting `showManageInstructionsModal = true` which binds to [isOpen] on the <ion-modal> wrapper around the component. -->

      <!-- DOCTOR PROFILE CONTENT -->
      <div *ngIf="userProfile?.role === 'doctor'">
        <app-doctor-profile
          [userProfile]="userProfile"
          [doctorStats]="doctorStats"
          [pendingRequests]="pendingRequests"
          [professionalSettings]="professionalSettings"
          [recentActivity]="recentActivity"
          [professionalCredentials]="professionalCredentials"
          (navigateToDashboard)="navigateToDoctorDashboard()"
          (acceptRequest)="acceptAccessRequest($event)"
          (declineRequest)="declineAccessRequest($event)"
          (settingsChanged)="saveProfessionalSettings()"
          (logoutRequested)="logout()">
        </app-doctor-profile>
      </div>
      <!-- End Doctor Profile Content -->

      <!-- BUDDY PROFILE CONTENT -->
      <div *ngIf="userProfile?.role === 'buddy'">
        <ng-container *ngIf="selectedTab === 'dashboard'">
          <div class="section-title">
            Buddy Dashboard
          </div>

          <div class="buddy-dashboard-card">
            <div class="dashboard-header">
              <ion-icon name="shield-checkmark-outline" color="tertiary"></ion-icon>
              <h3>Emergency Responder Dashboard</h3>
            </div>
            
            <div class="dashboard-quick-stats">
              <div class="quick-stat">
                <div class="stat-number">{{ buddyStats.protectedPatients }}</div>
                <div class="stat-label">Protected Patients</div>
              </div>
              <div class="quick-stat">
                <div class="stat-number">{{ buddyStats.emergencyResponses }}</div>
                <div class="stat-label">Emergency Responses</div>
              </div>
              <div class="quick-stat">
                <div class="stat-number">{{ buddyStats.invitations }}</div>
                <div class="stat-label">Pending Invitations</div>
              </div>
            </div>

            <ion-button 
              expand="block" 
              fill="solid" 
              color="tertiary"
              (click)="navigateToResponderDashboard()">
              <ion-icon name="shield-checkmark-outline" slot="start"></ion-icon>
              Access Responder Dashboard
            </ion-button>
          </div>
        </ng-container>

        <ng-container *ngIf="selectedTab === 'patients'">
          <div class="section-title">
            My Protected Patients
          </div>
          
          <p class="helper-text">Patients who have added you as their emergency buddy</p>
          
          <!-- Show actual patients if we have them -->
          <div *ngIf="protectedPatients && protectedPatients.length > 0" class="patients-list">
            <div *ngFor="let patient of protectedPatients" class="patient-card">
              <h3>{{ patient.firstName }} {{ patient.lastName }}</h3>
              <p>Email: {{ patient.email }}</p>
              <p>Accepted: {{ formatDate(patient.acceptedAt) }}</p>
            </div>
          </div>
          
          <div *ngIf="!protectedPatients || protectedPatients.length === 0" class="no-patients">
            <ion-icon name="people-outline" color="medium"></ion-icon>
            <p>No patients currently protected</p>
            <p class="helper-text">You'll see patients here when they add you as their emergency buddy</p>
          </div>
        </ng-container>

        <ng-container *ngIf="selectedTab === 'emergency'">
          <div class="section-title">
            Emergency Response Settings
          </div>
          
          <div class="emergency-settings-card">
            <div class="card-header">
              <ion-icon name="warning-outline" color="warning"></ion-icon>
              <h3>Response Preferences</h3>
            </div>
            
            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-title">Emergency Notifications</div>
                <div class="setting-desc">Receive emergency alerts from your patients</div>
              </div>
              <ion-toggle [(ngModel)]="buddySettings.emergencyNotifications" (ionChange)="saveBuddySettings()"></ion-toggle>
            </div>

            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-title">Location Sharing</div>
                <div class="setting-desc">Share your location during emergency response</div>
              </div>
              <ion-toggle [(ngModel)]="buddySettings.locationSharing" (ionChange)="saveBuddySettings()"></ion-toggle>
            </div>
          </div>
        </ng-container>

        <ng-container *ngIf="selectedTab === 'settings'">
          <div class="section-title">
            Buddy Settings
          </div>
          
          <div class="account-settings-card">
            <ion-button 
              expand="block" 
              fill="outline" 
              color="danger"
              (click)="logout()">
              <ion-icon name="log-out-outline" slot="start"></ion-icon>
              Logout
            </ion-button>
          </div>
        </ng-container>
      </div>
      <!-- End Buddy Profile Content -->
      
    </div>
    <!-- End profile-section -->
  </div>
  <!-- End profile-card -->
</ion-content>

<!-- Medication Details Modal -->
<ion-modal
  [isOpen]="showMedicationDetailsModal"
  (didDismiss)="closeMedicationDetails()"
  cssClass="force-white-modal"
  [initialBreakpoint]="1"
  [breakpoints]="[0,1]">
  <ng-template>
    <app-medication-details-modal
      [medication]="selectedMedication"
      [isEmergencyMedicationFn]="isEmergencyMedicationBind"
      [isExpiringSoonFn]="isExpiringSoonBind"
      [getMedicationTypeLabelFn]="getMedicationTypeLabelBind"
      [getRouteLabelFn]="getRouteLabelBind"
      (close)="closeMedicationDetails()">
    </app-medication-details-modal>
  </ng-template>
</ion-modal>
<!-- Global Emergency Message Edit Modal (moved outside tab-specific *ngIf to allow single-click open from any tab) -->
<ion-modal [isOpen]="showEditEmergencyMessageModal" (didDismiss)="closeEditEmergencyMessageModal()" cssClass="force-white-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar class="teal-modal-toolbar">
        <ion-title>Edit Emergency Message</ion-title>
        <ion-buttons slot="start">
          <ion-button (click)="closeEditEmergencyMessageModal()" fill="clear">
            <ion-icon name="arrow-back-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-buttons slot="end">
          <ion-button (click)="closeEditEmergencyMessageModal()" fill="clear">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding force-white-content">
      <ion-item class="eem-field" lines="none">
        <ion-label position="stacked">Name</ion-label>
        <ion-input placeholder="Enter name" [(ngModel)]="emergencyMessage.name"></ion-input>
      </ion-item>
      <ion-item class="eem-field" lines="none">
        <ion-label position="stacked">Allergies</ion-label>
        <ion-input readonly="true" [value]="emergencyMessage.allergies" placeholder="No allergies set"></ion-input>
      </ion-item>
      <ion-item class="eem-field" lines="none">
        <ion-label position="stacked">Instructions</ion-label>
        <ion-textarea autoGrow="true" placeholder="Enter instructions" [(ngModel)]="emergencyMessage.instructions"></ion-textarea>
      </ion-item>
      <ion-item class="eem-field" lines="none">
        <ion-label position="stacked">Location</ion-label>
        <ion-input placeholder="Enter location" [(ngModel)]="emergencyMessage.location"></ion-input>
      </ion-item>
      <ion-button expand="block" (click)="saveEmergencyMessage()">Save</ion-button>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Detailed Emergency Info Modal -->
<ion-modal [isOpen]="showEmergencyInfoModal" (didDismiss)="closeEmergencyInfoModal()" [initialBreakpoint]="1" [breakpoints]="[0, 1]">
  <ng-template>
    <app-emergency-details-modal
      [emergencyMessageName]="getEmergencyMessageName()"
      [userAllergies]="userAllergies"
      [instructionEntries]="getEmergencyInstructionEntries()"
      [emergencyLocation]="getEmergencyMessageLocation()"
      (close)="closeEmergencyInfoModal()"
      (editInstruction)="editInstructionEntry($event.label, $event.text)"
      (testAudio)="testAudioInstructions()">
    </app-emergency-details-modal>
  </ng-template>
</ion-modal>
