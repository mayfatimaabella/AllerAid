<ion-header [translucent]="true">
  <ion-toolbar class="toolbar--teal">
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>

    <ion-title>Profile</ion-title>
    
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding profile-page-bg">

  <section class="profile-header">
    <ion-avatar class="profile-avatar">
      <img alt="person-avatar"
           src="https://ionicframework.com/docs/img/demos/avatar.svg" />
    </ion-avatar>

    <div class="profile-name">
      {{ ((profileDataLoader.emergencyMessage$ | async)?.name || (profileDataLoader.userProfile$ | async)?.fullName || 'User') }}
    </div>
  </section>

  <section class="profile-card">

    <!-- USER STATS -->
    <section class="profile-stats"
         *ngIf="(profileDataLoader.userProfile$ | async)?.role === 'user'">

      <div class="stat">
        <div class="stat-label">Allergies</div>
        <div class="stat-value">{{ ((profileDataLoader.userAllergies$ | async)?.length) ?? 0 }}</div>
      </div>

      <div class="stat">
        <div class="stat-label">Medications</div>
        <div class="stat-value">{{ profileMedicationManager.medicationsCount }}</div>
      </div>
    </section>

    <!-- USER TABS -->
        <nav class="profile-tabs"
          *ngIf="(profileDataLoader.userProfile$ | async)?.role === 'user'">
            <button class="tab"
              [class.active]="profileNavigation.selectedTab === 'overview'"
              (click)="selectTab('overview')">Overview</button>

            <button class="tab"
              [class.active]="profileNavigation.selectedTab === 'health'"
              (click)="selectTab('health')">Health</button>

            <button class="tab"
              [class.active]="profileNavigation.selectedTab === 'ehr'"
              (click)="selectTab('ehr')">EHR</button>

            <button class="tab"
              [class.active]="profileNavigation.selectedTab === 'emergency'"
              (click)="selectTab('emergency')">Emergency</button>
    </nav>

    <!-- USER PROFILE CONTENT -->
    <section *ngIf="(profileDataLoader.userProfile$ | async)?.role === 'user'">
        
        <ng-container *ngIf="profileNavigation.selectedTab === 'overview'">
          <app-profile-overview-section

          [userAllergies]="(profileDataLoader.userAllergies$ | async) || []"
          [emergencyMessage]="(profileDataLoader.emergencyMessage$ | async)"
          [userProfile]="(profileDataLoader.userProfile$ | async)"
          [emergencyInstructions]="emergencyInstructionsManager.emergencyInstructions"
          [emergencyMessageName]="((profileDataLoader.emergencyMessage$ | async)?.name || (profileDataLoader.userProfile$ | async)?.fullName || 'User')"
          [emergencyInstructionsCombined]="((profileDataLoader.emergencyMessage$ | async)?.instructions || '')"
          [emergencyLocation]="((profileDataLoader.emergencyMessage$ | async)?.location || 'Map Location')"
          [openEditEmergencyMessageModal]="openEditEmergencyMessageModal.bind(this)"

          (openEditAllergies)="openEditAllergiesModal()"
          (openEmergencyInfo)="showEmergencyInfoModal = true"
          (testInstructionAudio)="testInstructionAudio($event)"
          >
          
          </app-profile-overview-section>
        </ng-container>
        
        
        <!-- Detailed Emergency Info Modal -->
         <ion-modal [isOpen]="showEmergencyInfoModal" (didDismiss)="showEmergencyInfoModal = false" [initialBreakpoint]="1" [breakpoints]="[0, 1]">
          <ng-template>
            <app-emergency-details-modal
            [emergencyMessageName]="((profileDataLoader.emergencyMessage$ | async)?.name || (profileDataLoader.userProfile$ | async)?.fullName || 'User')"
            [userAllergies]="(profileDataLoader.userAllergies$ | async) || []"
            [instructionEntries]="getEmergencyInstructionEntries()"
            [emergencyLocation]="((profileDataLoader.emergencyMessage$ | async)?.location || 'Map Location')"
            [openEditEmergencyMessageModal]="openEditEmergencyMessageModal.bind(this)"
            [openManageInstructionsModal]="openAddInstructionModal.bind(this)"
            (close)="showEmergencyInfoModal = false"
            (testAudio)="testAudioInstructions()"
            (addInstruction)="openAddInstructionModal()"
            (editInstruction)="openEditEmergencyMessageModal()"
            (openEditAllergies)="openEditAllergiesModal()"
            >
          </app-emergency-details-modal>
          </ng-template>
        </ion-modal>

      <ng-container *ngIf="profileNavigation.selectedTab === 'health'">
        <app-profile-health-section

          [userMedications]="$any((profileMedicationManager.userMedications$ | async) || [])"
          [filteredMedications]="$any((profileMedicationManager.filteredMedications$ | async) || [])"
          [medicationFilter]="profileMedicationManager.medicationFilter"
          [medicationSearchTerm]="profileMedicationManager.medicationSearchTerm"
          [isLoading]="$any(profileMedicationManager.isLoadingMedications$ | async)"

          [isEmergencyMedicationFn]="isEmergencyMedicationBind"
          [isMedicationDetailsExpandedFn]="isMedicationDetailsExpandedBind"
          [isExpiringSoonFn]="isExpiringSoonBind"
        
          (add)="openAddMedicationModal()"
          (search)="searchMedications($event)"
          (clearSearch)="clearMedicationSearch()"
          (medicationFilterChange)="profileMedicationManager.medicationFilter = $event; filterMedications()"
          (toggleDetails)="toggleMedicationDetails($event)"
          (toggleStatus)="toggleMedicationStatus($event)"

          (edit)="editMedication($event)"
          (delete)="deleteMedication($event)"
          (viewImage)="viewMedicationImage($event.url, $event.title)"
          (viewDetails)="openMedicationDetails($event)"
          ></app-profile-health-section>
        </ng-container>

      <!-- Medication Details Modal -->
       <ion-modal
      [isOpen]="profileMedicationManager.showMedicationDetailsModal"
       (didDismiss)="closeMedicationDetails()"
       cssClass="force-white-modal"
       [initialBreakpoint]="1"
       [breakpoints]="[0,1]">
       
       <ng-template>
        <app-medication-details-modal
        [medication]="profileMedicationManager.selectedMedication"
        [isEmergencyMedicationFn]="isEmergencyMedicationBind"
        [isExpiringSoonFn]="isExpiringSoonBind"
        (close)="closeMedicationDetails()">
        </app-medication-details-modal>
       </ng-template>
      </ion-modal>

      <ng-container *ngIf="profileNavigation.selectedTab === 'ehr'">
        <app-ehr-section-cards
          [doctorVisits]="profileEHRManager.doctorVisits"
          [medicalHistory]="profileEHRManager.medicalHistory"
          [ehrAccessList]="profileEHRManager.ehrAccessList"

          [isLoadingDoctorVisits]="profileEHRManager.isLoadingDoctorVisits"
          [isLoadingMedicalHistory]="profileEHRManager.isLoadingMedicalHistory"
          [isDoctorVisitsExpanded]="profileEHRManager.isDoctorVisitsExpanded"
          [isMedicalHistoryExpanded]="profileEHRManager.isMedicalHistoryExpanded"
          
          (addDoctorVisit)="openAddDoctorVisitModal()"
          (addMedicalHistory)="openAddMedicalHistoryModal()"

          (sendAccessRequest)="sendAccessRequest()"
           (revokeEHRAccess)="revokeEHRAccess($event)"

           (openVisitDetails)="openVisitDetails($event)"
           (editDoctorVisit)="openEditDoctorVisitModal($event)"
           (deleteDoctorVisit)="deleteDoctorVisit($event.id ?? '')"
           (openMedicalHistoryDetails)="openMedicalHistoryDetails($event)"
           (presentVisitActionsPopover)="presentVisitActionsPopover($event)"
           (presentHistoryActionsPopover)="presentHistoryActionsPopover($event)"
        ></app-ehr-section-cards>
      </ng-container>
      
        <!-- EMERGENCY!-->

      <ng-container *ngIf="profileNavigation.selectedTab === 'emergency'">

        <app-emergency-settings-card
          [emergencySettings]="profileEmergencySettings.emergencySettings"
          [showVoiceSettings]="profileEmergencySettings.showVoiceSettings"
          [getAudioSourceClass]="profileVoiceFacade.getAudioSourceClass.bind(profileVoiceFacade)"
          [getAudioSourceText]="profileVoiceFacade.getAudioSourceText.bind(profileVoiceFacade)"
          [openVoiceRecordingModal]="openVoiceRecordingModal.bind(this)"
          [saveEmergencySettings]="saveEmergencySettings.bind(this)"
          [isEmergencyInstructionsEmpty]="isEmergencyInstructionsEmpty.bind(this)"
          [openEditEmergencyMessageModal]="openEditEmergencyMessageModal.bind(this)"
          [testEmergencyAlert]="testEmergencyAlert"
          [testShakeDetection]="testShakeDetection"
          [testPowerButtonDetection]="testPowerButtonDetection"
          [testAudioInstructions]="testAudioInstructions"
          [requestMotionPermissions]="requestMotionPermissions"
          [showEmergencyExamples]="showEmergencyExamples.bind(this)"
          [emergencyMessage]="(profileDataLoader.emergencyMessage$ | async)"
          [userProfile]="(profileDataLoader.userProfile$ | async)"
          [emergencyInstructions]="emergencyInstructionsManager.emergencyInstructions"
          [userAllergies]="(profileDataLoader.userAllergies$ | async) || []"
          [showManageInstructionsModal]="emergencyInstructionsManager.showManageInstructionsModal"
          [editingInstruction]="emergencyInstructionsManager.editingInstruction"
          [selectedInstructionDetails]="emergencyInstructionsManager.selectedInstructionDetails"
          [showInstructionDetailsModal]="emergencyInstructionsManager.showInstructionDetailsModal"
          [openManageInstructionsModal]="openAddInstructionModal.bind(this)"
          [onManageInstructionsDismiss]="emergencyInstructionsManager.onManageInstructionsDismiss.bind(emergencyInstructionsManager)"
          [onAddInstruction]="emergencyInstructionsManager.onAddInstruction.bind(emergencyInstructionsManager)"
          [onUpdateInstruction]="emergencyInstructionsManager.onUpdateInstruction.bind(emergencyInstructionsManager)"
          [onRemoveInstruction]="emergencyInstructionsManager.onRemoveInstruction.bind(emergencyInstructionsManager)"
          [onEditInstruction]="emergencyInstructionsManager.onEditInstruction.bind(emergencyInstructionsManager)"
          [onCancelEdit]="emergencyInstructionsManager.onCancelEdit.bind(emergencyInstructionsManager)"
          [onShowDetails]="emergencyInstructionsManager.onShowDetails.bind(emergencyInstructionsManager)"
        >

        </app-emergency-settings-card>

        <!-- Emergency Examples Modal -->
        <app-emergency-examples-modal
          [isOpen]="showExamplesModal"
          (closeModal)="showExamplesModal = false">
        </app-emergency-examples-modal>
        
        <!-- Voice Recording Settings (Expandable) -->
        <div class="voice-settings-section" *ngIf="profileEmergencySettings.emergencySettings.audioInstructions && profileEmergencySettings.showVoiceSettings">
          <!-- Recording Controls -->
          <div class="voice-recording-controls">
            <h4>Record Custom Voice</h4>
            <p>Record your own voice for emergency instructions</p>
            
            <div class="recording-zone" [class.recording]="profileVoiceFacade.isRecording">
              <div class="recording-status">
                <ion-icon [name]="profileVoiceFacade.isRecording ? 'mic' : 'mic-outline'"></ion-icon>
                <span *ngIf="!profileVoiceFacade.isRecording">Ready to Record</span>
                <span *ngIf="profileVoiceFacade.isRecording">Recording... {{ profileVoiceFacade.formatDuration(profileVoiceFacade.recordingTime) }}</span>
              </div>
              
              <div class="recording-buttons">
                <ion-button *ngIf="!profileVoiceFacade.isRecording" 
                            (click)="profileVoiceFacade.startRecording()" 
                            color="danger" 
                            fill="solid">
                  <ion-icon name="mic" slot="start"></ion-icon>
                  Start Recording
                </ion-button>
                
                <ion-button *ngIf="profileVoiceFacade.isRecording" 
                            (click)="profileVoiceFacade.stopRecording()" 
                            color="success" 
                            fill="solid">
                  <ion-icon name="stop" slot="start"></ion-icon>
                  Stop Recording
                </ion-button>
              </div>
            </div>
          </div>

          <!-- Recordings List -->
          <div class="voice-recordings-list" *ngIf="profileVoiceFacade.recordings.length > 0">
            <h4>Your Recordings</h4>
            <div class="recording-item" *ngFor="let recording of profileVoiceFacade.recordings">
              <div class="recording-info">
                <div class="recording-name">
                  <span>{{ recording.name }}</span>
                  <ion-icon *ngIf="profileVoiceFacade.isRecordingSelected(recording.id)" 
                            name="checkmark-circle" 
                            color="success"></ion-icon>
                </div>
                <div class="recording-details">
                  <span>{{ profileVoiceFacade.formatDuration(recording.duration) }}</span>
                  <span>{{ profileVoiceFacade.formatFileSize(recording.size) }}</span>
                </div>
              </div>
              <div class="recording-actions">
                <ion-button (click)="profileVoiceFacade.playRecording(recording.id)" 
                            fill="clear" 
                            size="small">
                  <ion-icon name="play" slot="icon-only"></ion-icon>
                </ion-button>
                <ion-button (click)="profileVoiceFacade.selectRecording(recording.id)" 
                            fill="clear" 
                            size="small"
                            [color]="profileVoiceFacade.isRecordingSelected(recording.id) ? 'success' : 'medium'">
                  <ion-icon name="checkmark" slot="icon-only"></ion-icon>
                </ion-button>
                <ion-button (click)="profileVoiceFacade.deleteRecording(recording)" 
                            fill="clear" 
                            size="small" 
                            color="danger">
                  <ion-icon name="trash" slot="icon-only"></ion-icon>
                </ion-button>
              </div>
            </div>
          </div>

          <!-- Audio Settings -->
          <div class="voice-audio-settings">
            <h4>Audio Settings</h4>
            
            <div class="setting-item">
              <div class="setting-info">
                <label>Use Custom Voice</label>
                <p>Play your recorded message instead of text-to-speech</p>
              </div>
              <ion-toggle [(ngModel)]="profileVoiceFacade.audioSettings.useCustomVoice" 
                          (ionChange)="profileVoiceFacade.onAudioSettingChange()"></ion-toggle>
            </div>

            <div class="setting-item" *ngIf="!profileVoiceFacade.audioSettings.useCustomVoice">
              <div class="setting-info">
                <label>Default Voice</label>
                <p>Choose text-to-speech voice type</p>
              </div>
              <ion-select [(ngModel)]="profileVoiceFacade.audioSettings.defaultVoice" 
                          (ionChange)="profileVoiceFacade.onAudioSettingChange()"
                          interface="popover">
                <ion-select-option value="female">Female</ion-select-option>
                <ion-select-option value="male">Male</ion-select-option>
              </ion-select>
            </div>

            <div class="setting-item">
              <div class="setting-info">
                <label>Speech Rate ({{ profileVoiceFacade.audioSettings.speechRate }}x)</label>
                <p>How fast the audio plays</p>
              </div>
              <ion-range [(ngModel)]="profileVoiceFacade.audioSettings.speechRate"
                         (ionChange)="profileVoiceFacade.onAudioSettingChange()"
                         min="0.5"
                         max="2.0"
                         step="0.1"
                         pin="true">
              </ion-range>
            </div>

            <div class="setting-item">
              <div class="setting-info">
                <label>Volume ({{ (profileVoiceFacade.audioSettings.volume * 100).toFixed(0) }}%)</label>
                <p>Audio playback volume</p>
              </div>
              <ion-range [(ngModel)]="profileVoiceFacade.audioSettings.volume"
                         (ionChange)="profileVoiceFacade.onAudioSettingChange()"
                         min="0"
                         max="1"
                         step="0.1"
                         pin="true">
              </ion-range>
            </div>

            <ion-button (click)="runEmergencyTest('audio')" 
                        expand="block" 
                        fill="outline" 
                        color="secondary">
              <ion-icon name="volume-high" slot="start"></ion-icon>
              Test Audio Settings
            </ion-button>
          </div>
        </div>

      </ng-container>
    </section>

    <!-- DOCTOR PROFILE -->
    <section *ngIf="(profileDataLoader.userProfile$ | async)?.role === 'doctor'">
      <app-doctor-profile
        [userProfile]="(profileDataLoader.userProfile$ | async)"
        [doctorStats]="doctorStats"
        [pendingRequests]="profileAccessRequest.pendingRequests"
        [professionalSettings]="professionalSettings"
        [recentActivity]="recentActivity"
        [professionalCredentials]="professionalCredentials"
        (navigateToDashboard)="navigateToDoctorDashboard()"
        (acceptRequest)="acceptAccessRequest($event)"
        (declineRequest)="declineAccessRequest($event)"
        (settingsChanged)="saveProfessionalSettings()"
        (logoutRequested)="logout()">
      </app-doctor-profile>
    </section>

  </section>
</ion-content>

<!-- Add Emergency Message Modal -->
<ion-modal [isOpen]="showAddEmergencyMessageModal" (didDismiss)="showAddEmergencyMessageModal = false">
  <app-edit-emergency-message-modal
    [emergencyMessage]="{ name: '', allergies: '', instructions: '', location: '' }"
    [mode]="'add'"
    (saveModal)="saveNewEmergencyMessage($event)"
    (closeModal)="showAddEmergencyMessageModal = false">
  </app-edit-emergency-message-modal>
</ion-modal>

<!-- Edit Emergency Message Modal (if present) -->
<ion-modal [isOpen]="profileEmergencySettings.showEditEmergencyMessageModal" (didDismiss)="profileEmergencySettings.showEditEmergencyMessageModal = false">
  <app-edit-emergency-message-modal
    [emergencyMessage]="(profileDataLoader.emergencyMessage$ | async)"
    [mode]="'edit'"
    (saveModal)="saveEditedEmergencyMessage($event)"
    (closeModal)="profileEmergencySettings.showEditEmergencyMessageModal = false">
  </app-edit-emergency-message-modal>
</ion-modal>

<!-- Emergency Specific Instructions Modal - Available on all tabs -->
<ion-modal [isOpen]="emergencyInstructionsManager.showManageInstructionsModal" (didDismiss)="emergencyInstructionsManager.onManageInstructionsDismiss()">
  <ng-template>
    <app-emergency-specific-instructions-modal></app-emergency-specific-instructions-modal>
  </ng-template>
</ion-modal>