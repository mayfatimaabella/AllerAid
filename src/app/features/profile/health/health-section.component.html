<div class="section-title">
  Medications 
</div>

<!-- Medication Search -->
<div class="medication-search">
  <ion-searchbar 
    [value]="medicationSearchTerm"
    (ionInput)="search.emit($event)"
    (ionClear)="clearSearch.emit()"
    placeholder="Search medications..."
    showClearButton="focus"
    debounce="300">
  </ion-searchbar>
  <div *ngIf="medicationSearchTerm && medicationSearchTerm.trim()" class="search-results-info">
  <small>
      {{ filteredMedications.length }} of {{ userMedications.length }} medications found
    </small>
  </div>
  
</div>

<!-- Medication Filter -->  
<div class="medication-filters">
  <ion-segment [ngModel]="medicationFilter" (ionChange)="onFilterChange($event)">
    <ion-segment-button value="all">
      <ion-icon name="list-outline"></ion-icon>
    </ion-segment-button>
    <ion-segment-button value="active">
      <ion-icon name="medkit-outline"></ion-icon>
    </ion-segment-button>
  </ion-segment>
</div>

<!-- Medications List -->
<div class="medications-list">
  <!-- Loading state -->
  <div *ngIf="isLoading && (!userMedications || userMedications.length === 0)" class="loading-state">
  <ion-skeleton-text animated class="medication-skeleton"></ion-skeleton-text>
  <ion-skeleton-text animated class="medication-skeleton"></ion-skeleton-text>
  <ion-skeleton-text animated class="medication-skeleton"></ion-skeleton-text>
  </div>

  <!-- Actual content when not loading -->
  <ng-container *ngIf="!isLoading">
  <div *ngFor="let medication of filteredMedications; trackBy: trackByMedication" 
    class="medication-card" 
    [ngClass]="{ 'emergency-medication': isEmergencyMedication(medication) }"
    (click)="viewDetails.emit(medication)"
    style="cursor: pointer;">
          
    <div class="medication-header">
      <div class="medication-title-section">
        <span class="medication-title">{{ medication.name }}</span>
        <div class="medication-summary">
           <span class="dosage">{{ medication.dosage }}</span>
           <span class="frequency" *ngIf="medication.frequency"> • {{ medication.frequency }}</span>
           <span class="pills" *ngIf="medication.quantity"> • {{ calculateRemainingPills(medication) }} pills left</span>
        </div>

      </div>
      <div class="medication-actions">
        <ion-chip 
          [color]="medication.isActive ? 'success' : 'medium'" 
          size="small">
          {{ medication.isActive ? 'Active' : 'Inactive' }}
        </ion-chip>

        <div class="action-buttons">
          <ion-button 
            fill="clear" 
            color="medium" 
            size="small"
            *ngIf="medication.id"
            (click)="$event.stopPropagation(); presentMedicationActions(medication)"
            aria-label="Medication actions"
            title="More actions">
            <ion-icon name="ellipsis-vertical-outline"></ion-icon>
          </ion-button>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="!isLoading && filteredMedications.length === 0" class="no-medications">
  <div class="no-medications-container">
  <ion-icon name="medical-outline" class="no-medications-icon"></ion-icon>
  <p class="no-medications-text">
        <ng-container *ngIf="medicationSearchTerm && medicationSearchTerm.trim(); else noMedicationsAtAll">
          No medications found matching "{{ medicationSearchTerm }}"
        </ng-container>
        <ng-template #noMedicationsAtAll>
          No medications recorded
        </ng-template>
      </p>

      <ion-button 
        *ngIf="medicationSearchTerm && medicationSearchTerm.trim()"
        fill="outline" 
        size="small" 
        (click)="clearSearch.emit()">
        <ion-icon name="close-outline" slot="start"></ion-icon>
        Clear Search
      </ion-button>
    </div>
  </div>
  </ng-container>
</div>

<!-- FAB -->
<ion-fab class="add-med-fab" horizontal="end" vertical="bottom">
  <ion-fab-button (click)="add.emit()" aria-label="Add medication">
    <ion-icon name="add"></ion-icon>
  </ion-fab-button>
</ion-fab>
