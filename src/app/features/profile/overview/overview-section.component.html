<div class="section-title">
  Allergies <ion-icon name="settings-outline" (click)="openEditAllergies.emit()"></ion-icon>
</div>

<div class="allergy-list-container">
  <div class="allergy-list-scrollable">
    <span *ngFor="let allergy of userAllergies" class="allergy-chip">{{ allergy.label || allergy.name }}</span>
    <span *ngIf="userAllergies.length === 0" class="no-data">No allergies recorded</span>
  </div>
  
  <div class="section-title">Emergency Instructions & Message</div>

  <ion-card class="emergency-info-card" (click)="openEmergencyInfo.emit()">
    <ion-card-header>
      <div class="emergency-header">
        <ion-icon name="information-circle-outline" class="emergency-icon"></ion-icon>
        <div class="emergency-title">Emergency Information</div>
      </div>
    </ion-card-header>
    <ion-card-content>
      <div class="emergency-section">
        <div class="emergency-label">NAME</div>
        <div class="emergency-value">{{ emergencyMessageName }}</div>
      </div>
      <div class="emergency-section allergies-section">
        <div class="emergency-label">ALLERGIES</div>
        <div class="allergy-chips">
          <span *ngFor="let allergy of userAllergies" class="allergy-chip">{{ allergy.label || allergy.name }}</span>
          <span *ngIf="userAllergies?.length === 0" class="no-data">None</span>
        </div>
      </div>
      <div class="emergency-section">
        <div class="emergency-label">INSTRUCTIONS</div>
        <div class="emergency-value instructions">{{ emergencyInstructionsCombined }}</div>
      </div>
      <div class="emergency-section location-section">
        <div class="emergency-label">LOCATION</div>
        <div class="emergency-value">{{ emergencyLocation || 'Map Location' }}</div>
      </div>
      <div class="tap-details">
        <ion-icon name="finger-print-outline"></ion-icon>
        TAP FOR FULL DETAILS
      </div>
    </ion-card-content>
  </ion-card>
</div>

<!-- Instruction Details Modal (localized in child) -->
<ion-modal [isOpen]="showInstructionDetailsModal" (didDismiss)="closeInstructionDetails()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Emergency Instruction Details</ion-title>
        <ion-buttons slot="start">
          <ion-button (click)="closeInstructionDetails()" fill="clear">
            <ion-icon name="arrow-back-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-buttons slot="end">
          <ion-button (click)="closeInstructionDetails()" fill="clear">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding" *ngIf="selectedInstructionDetails">
      <div class="instruction-details-container">
        <div class="detail-section">
          <div class="detail-header">
            <ion-icon name="warning-outline" color="danger"></ion-icon>
            <h3>Allergy Information</h3>
          </div>
          <div class="detail-content">
            <div class="detail-row">
              <span class="detail-label">Allergy:</span>
              <span class="detail-value">{{ selectedInstructionDetails.allergyName }}</span>
            </div>
            <div class="detail-row" *ngIf="selectedInstructionDetails.allergyId !== selectedInstructionDetails.allergyName">
              <span class="detail-label">ID:</span>
              <span class="detail-value">{{ selectedInstructionDetails.allergyId }}</span>
            </div>
          </div>
        </div>
        <div class="detail-section">
          <div class="detail-header">
            <ion-icon name="medical-outline" color="primary"></ion-icon>
            <h3>Emergency Instructions</h3>
          </div>
          <div class="detail-content">
            <div class="instruction-full-text">
              {{ selectedInstructionDetails.instruction }}
            </div>
          </div>
        </div>
        <div class="detail-section">
          <div class="detail-header">
            <ion-icon name="settings-outline" color="medium"></ion-icon>
            <h3>Quick Actions</h3>
          </div>
          <div class="detail-content">
            <div class="action-buttons-grid">
              <ion-button expand="block" fill="outline" color="primary" (click)="editInstructionFromDetails()">
                <ion-icon name="create-outline" slot="start"></ion-icon>
                Edit Instruction
              </ion-button>
              <ion-button expand="block" fill="outline" color="success" (click)="onTestInstructionAudio()">
                <ion-icon name="volume-high-outline" slot="start"></ion-icon>
                Test Audio
              </ion-button>
              <ion-button expand="block" fill="outline" color="warning" (click)="onShareInstruction()">
                <ion-icon name="share-outline" slot="start"></ion-icon>
                Share
              </ion-button>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>
