<ion-toolbar class="dark-toolbar">
  <ion-buttons slot="start">
    <ion-menu-button></ion-menu-button>
  </ion-buttons>

  <ion-title>AllerAid</ion-title>

  <ion-buttons slot="end">
    <ion-button fill="clear" [routerLink]="['/tabs/alerts']">
      <ion-icon name="alert-circle-outline"></ion-icon>
    </ion-button>

    <ion-button fill="clear" size="small" (click)="openNotifications()">
      <img src="assets/icon/bell.png" alt="bell" class="notif-icon" />
    </ion-button>
  </ion-buttons>
</ion-toolbar>

<ion-content class="ion-padding" [scrollY]="true">
  <div class="wrapper scrollable-content">
    <h2 class="page-title">Welcome, {{ userName }}!</h2>

    <div class="emergency-wrapper">
      <div class="circle-button" (click)="triggerEmergency()">
        <ion-icon name="notifications-outline"></ion-icon>
        <h2 class="emergency-title">EMERGENCY</h2>
        <p class="instruction-text">Press the button or shake</p>
      </div>
      <p class="bottom-text">Press the button above in case of emergency</p>
    </div>

    <!-- Show the emergency response notification when a buddy responds -->
    <app-emergency-response-notification 
      *ngIf="respondingBuddy"
      [responderName]="respondingBuddy.responderName"
      [estimatedTime]="respondingBuddy.estimatedTime"
      [distance]="respondingBuddy.distance"
      [estimatedMinutes]="respondingBuddy.estimatedArrival"
      (viewMap)="openResponderMap(respondingBuddy)"
      (dismiss)="respondingBuddy = null">
    </app-emergency-response-notification>

    <!-- Emergency Status Card -->
    <ion-card *ngIf="isEmergencyActive" class="emergency-status-card">
      <ion-card-header>
        <ion-card-title class="emergency-title-row">
          <ion-icon name="alert-circle" color="danger"></ion-icon>
          EMERGENCY ACTIVE
        </ion-card-title>
        <ion-card-subtitle>
          Started: {{ emergencyStartTime | date:'short' }}
        </ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <div class="emergency-info">
          <p><strong>Location:</strong>
            <span *ngIf="isEmergencyAddressLoading">Resolving address...</span>
            <span *ngIf="!isEmergencyAddressLoading && emergencyAddress">{{ emergencyAddress }}</span>
            <span *ngIf="!isEmergencyAddressLoading && !emergencyAddress && emergencyLocation">
              {{ emergencyLocation.latitude.toFixed(4) }}, {{ emergencyLocation.longitude.toFixed(4) }}
            </span>
            <span *ngIf="!emergencyLocation && !isEmergencyAddressLoading">Updating...</span>
          </p>
          
          <div class="buddy-responses" *ngIf="hasBuddyResponses()">
            <h4>Buddy Responses & Notifications:</h4>
            <div class="response-list">
              <div *ngFor="let buddyId of getObjectKeys(buddyResponses)" class="response-item">
                <div class="buddy-info">
                  <span class="buddy-name">{{ buddyResponses[buddyId].name }}</span>
                  <div class="buddy-status">
                    <ion-badge [color]="getBuddyResponseColor(buddyId)" class="status-badge">
                      {{ getBuddyResponseStatus(buddyId) }}
                    </ion-badge>
                    <ion-badge [color]="getNotificationStatusColor(buddyId)" class="notification-badge">
                      {{ getNotificationStatus(buddyId) }}
                    </ion-badge>
                  </div>
                </div>
                <div class="response-time">
                  {{ buddyResponses[buddyId].timestamp | date:'short' }}
                </div>
              </div>
            </div>
          </div>
          
          <div class="emergency-actions">
            <ion-button 
              expand="block" 
              color="success" 
              (click)="resolveEmergency()"
              class="mt-16">
              <ion-icon name="checkmark-circle" slot="start"></ion-icon>
              Mark as Resolved
            </ion-button>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <ion-card>
      <ion-card-header>
        <ion-card-title>Health Overview</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <p><strong>Allergens:</strong> 
          <span *ngIf="userAllergies.length > 0">
            {{ userAllergies.length }} recorded
          </span>
          <span *ngIf="userAllergies.length === 0">None recorded</span>
        </p>
        <p><strong>Buddies:</strong> {{ getBuddiesCount() }}</p>
      </ion-card-content>
    </ion-card>

    <!-- Pollen Map Section -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Pollen Map</ion-card-title>
        <ion-card-subtitle>Local pollen levels and hotspots</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <div class="pollen-map-preview">
          <img src="assets/icon/pollen-map-placeholder.png" alt="Pollen Map" class="pollen-map-image" />
          <p class="pollen-map-note">This is a placeholder pollen map. Tap "Open Map" to view an interactive map (coming soon).</p>
          <ion-button expand="block" fill="outline" color="primary" (click)="openPollenMap()">
            <ion-icon name="map" slot="start"></ion-icon>
            Open Map
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

    

    

    <!-- Test Emergency Notifications (Development Mode) -->
    <ion-card *ngIf="!isEmergencyActive">
      <ion-card-header>
        <ion-card-title>Emergency Notification Test</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <p>Test the emergency notification system (SMS & Push notifications)</p>
        <ion-button 
          expand="block" 
          fill="outline" 
          color="warning" 
          (click)="testEmergencyNotifications()">
          <ion-icon name="flash" slot="start"></ion-icon>
          Test Notifications
        </ion-button>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
